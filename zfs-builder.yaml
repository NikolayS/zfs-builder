---
apiVersion: v1
kind: List
items:
  # FIXME: Uncomment this to dogfood
  # - apiVersion: v1
  #   kind: PersistentVolumeClaim
  #   metadata:
  #     name: zfs-kernel-modules
  #     annotations:
  #       dotmeshName: zfs-kernel-modules@master
  #   spec:
  #     storageClassName: dotmesh
  #     accessModes:
  #       - ReadWriteOnce
  #     resources:
  #       requests:
  #         storage: 1Gi
  - apiVersion: batch/v1beta1
    kind: CronJob
    metadata:
      name: zfs-builder
    spec:
      schedule: "0 * * * *" # Run every hour
      jobTemplate:
        spec:
          template:
            spec:
              containers:
              - name: zfs-builder
                image: 'quay.io/dotmesh/zfs-builder:dev'
                volumeMounts:
                  - name: docker-sock
                    mountPath: /var/run/docker.sock
                  - name: tmp
                    mountPath: /rootfs
                  - name: zfs-module-cache
                    mountPath: /zfs-module-cache
                  - name: release-ssh-keys
                    mountPath: /ssh-keys
                    readOnly: true
              volumes:
                - name: docker-sock
                  hostPath:
                    path: /var/run/docker.sock
                - name: tmp
                  hostPath:
                    path: /tmp/zfs-builder
                - name: zfs-module-cache
                  # FIXME: Swap this over to dogfood
                  hostPath:
                    path: /tmp/zfs-kernel-modules
                  # persistentVolumeClaim:
                  #   claimName: zfs-kernel-modules
                - name: release-ssh-keys
                  secret:
                    secretName: release-ssh-keys
              restartPolicy: OnFailure
